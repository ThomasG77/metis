!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r(e.DataGraph=e.DataGraph||{})}(this,function(e){"use strict";function r(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q;if("string"==typeof e||"object"===!(void 0===e?"undefined":_(e)))return e;switch(e.type){case"=":case"<>":case"<":case">":case"<=":case">=":return e.left+" "+e.type+" "+("string"==typeof e.right?"'"+e.right+"'":e.right);case"between":case"not between":return e.field+" "+e.type.toUpperCase()+" "+e.left+" AND "+e.right;case"is null":case"is not null":return e.field+" "+e.type.toUpperCase();case"ilike":case"like":case"not like":return e.left+" "+e.type.toUpperCase()+" '%"+e.right+"%'";case"coalesce":return"COALESCE("+e.values.map(function(e){return"'"+e+"'"}).join(", ")+")";case"in":case"not in":return Array.isArray(e.set)?e.expr+" "+e.type.toUpperCase()+" ("+e.set.map(function(e){return"number"==typeof e?e:"'"+e+"'"}).join(", ")+")":"object"!==_(e.set)||"data"!==e.set.type&&"root"!==e.set.type?e:e.expr+" "+e.type.toUpperCase()+" ("+t.writeSQL(e.set)+")";case"not":return"NOT("+r(e.expr)+")";case"and":case"or":return"("+r(e.left)+" "+e.type.toUpperCase()+" "+r(e.right)+")";case"case":return"CASE WHEN "+e.cond.map(function(e){return r(e[0])+" THEN "+e[1]}).join(" ")+(e.else?" ELSE '"+e.else+"'":"")+" END";case"date_trunc":return"date_trunc("+e.unit+", "+e.field+")";case"extract":return"extract("+e.unit+" from "+e.field+")";case"root":return"("+t.writeSQL(e)+")";case"count":return e.distinct&&e.approx?"approx_count_distinct("+e.field+")":e.distinct?"count(distinct "+e.field+" )":"count("+e.field+")";case"stddev":case"stddev_pop":case"stddev_samp":case"var_pop":case"var_samp":return e.type+"("+e.x+")";case"corr":case"covar_pop":case"covar_samp":return e.type+"("+e.x+", "+e.y+")";case"min":case"max":case"sum":return e.type+"("+e.field+")";case"average":return"avg("+e.field+")";default:return e}}function t(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{select:[],from:"",where:[],groupby:[],having:[],orderby:[],limit:"",offset:"",unresolved:{}};return e.transform.reduce(function(e,t){return r.parseTransform(e,t)},{select:t.select,from:"root"===e.type?"string"==typeof e.source?e.source:r.parseSource(e.source):t.from,where:t.where,groupby:t.groupby,having:t.having,orderby:t.orderby,limit:t.limit,offset:t.offset,unresolved:t.unresolved})}function n(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q;return Array.isArray(r.groupby)?r.groupby.forEach(function(r){e=i(e,r,t)}):e=i(e,r.groupby,t),r.fields.forEach(function(t,n){var i=r.as[n];e.select.push(o(r.ops[n],t,i))}),e}function o(e,r,t){var n="";return(n+=null===e?r:P[e]?P[e]+"("+r+")":e+"("+r+")")+(t?" as "+t:"")}function i(e,r,t){return"string"==typeof r?(e.select.push(r),e.groupby.push(r)):"bin"===r.type?(e=t.parseTransform(e,r)).groupby.push(r.as):"project"===r.type&&(e.select.push(t.parseExpression(r.expr)+(r.as?" as "+r.as:"")),r.as&&e.groupby.push(r.as)),e}function a(e,r){var t=r.field,n=r.as,o=r.extent,i=r.maxbins;return e.select.push("cast((cast("+t+" as float) - "+o[0]+") * "+i/(o[1]-o[0])+" as int) as "+n),e.where.push("(("+t+" >= "+o[0]+" AND "+t+" <= "+o[1]+") OR ("+t+" IS NULL))"),e.having.push("("+n+" >= 0 AND "+n+" < "+i+" OR "+n+" IS NULL)"),e}function u(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q;switch(r.type){case"filter":e.where.push("("+("object"===_(r.expr)?t.parseExpression(r.expr):r.expr)+")");default:return e}}function s(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q;switch(r.type){case"crossfilter":"object"===_(e.unresolved)&&e.unresolved.hasOwnProperty(r.signal)&&Object.keys(r.filter).forEach(function(n){var o=r.filter[n];if(e.unresolved){var i=e.unresolved[r.signal].ignore;(Array.isArray(i)?-1===i.indexOf(n):n!==i)&&u(e,o,t)}});default:return e}}function c(e,r){return r.field.forEach(function(t,n){e.orderby.push(t+(Array.isArray(r.order)?" "+R[r.order[n]]:""))}),e}function f(e,r){return e.limit+=r.row,e.offset+=r.offset||e.offset,e}function p(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Q;return e.select.push(t.parseExpression(r.expr)+(r.as?" as "+r.as:"")),e}function l(e,r){switch(r.type){case"resolvefilter":"object"===_(e.unresolved)?e.unresolved[r.filter.signal]=r:e.unresolved=U({},r.filter.signal,r);default:return e}}function d(e,r){if("multiplicative"===r.method){var t=r.size,n=r.limit,o=Math.min(n/t,1);if(1>o){var i=Math.floor(H*o);e.where.push("MOD("+e.from+".rowid * "+G+", "+H+") < "+i)}}return e}function y(e){switch(e){case"join.left":return"LEFT JOIN";case"join.right":return"RIGHT JOIN";case"join.inner":return"INNER JOIN";case"join":default:return"JOIN"}}function g(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Q;return e.reduce(function(e,t,n){if("string"==typeof t.table&&"scan"===t.type)return e.concat(t.table);if("join"===t.type||"join.inner"===t.type||"join.left"===t.type||"join.right"===t.type){var o=e.pop(),i=e.pop()+" "+y("string"==typeof t.type?t.type:"join")+" "+o,a="string"==typeof t.as?" as "+t.as:"";return e.concat(i+a)}if("data"===t.type||"root"===t.type){var u=r.writeSQL(t);return e.concat("("+u+")")}return e},[]).join()}function v(e,r,t){switch(r.type){case"aggregate":return n(e,r,t);case"bin":return a(e,r);case"sort":return c(e,r);case"limit":return f(e,r);case"filter":return u(e,r,t);case"project":return p(e,r,t);case"sample":return d(e,r);case"resolvefilter":return l(e,r);case"crossfilter":return s(e,r);default:return e}}function h(e,r){return m(r.parseDataState(e))}function m(e){return b(e.select)+x(e.from)+j(e.where)+w(e.groupby)+E(e.having)+S(e.orderby)+A(e.limit)+O(e.offset)}function b(e){return e.length?"SELECT "+e.join(", "):"SELECT *"}function x(e){return" FROM "+e}function j(e){return e.length?" WHERE "+e.join(" AND "):""}function w(e){return e.length?" GROUP BY "+e.join(", "):""}function E(e){return e.length?" HAVING "+e.join(" AND "):""}function S(e){return e.length?" ORDER BY "+e.join(", "):""}function A(e){return e.length?" LIMIT "+e:""}function O(e){return e.length?" OFFSET "+e:""}function N(){var e={},n={},o={parseExpression:function(e){return n[e.type]?n[e.type](e,o):r(e,o)},parseTransform:function(r,t){return e[t.type]?e[t.type](r,t,o):v(r,t,o)},parseDataState:function(e,r){return t(e,o,r)},parseSource:function(e){return g(e,o)},writeSQL:function(e){return h(e,o)},write:m,registerParser:function(r,t){"expression"===r.meta?n[r.type]=t:"transform"===r.meta&&(e[r.type]=t)}};return o}function D(e,r,t,n){n=t(n,r(e));var o=e.getState().source;return"object"!==(void 0===o?"undefined":_(o))||Array.isArray(o)?n:D(o,r,t,n)}function C(e,r){return D(r,J,function(r,t){return e.parser.parseDataState(t.getState(),r)},{select:[],from:"",where:[],groupby:[],having:[],orderby:[],limit:"",offset:"",unresolved:{}})}function L(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t={type:r.type||"data",source:r.source,transform:r.transform||[],children:r.children||[]},n={getState:function(){return t},transform:function(e){return t.transform="function"==typeof e?e(t.transform):e,n},toSQL:function(){return e.parser.write(C(e,n))},values:function(){return e.connector.query(e.parser.write(C(e,n)))},data:function(r){var o=L(e,M({},r,{source:n}));return t.children.push(o),o}};return n}function I(e){return Array.isArray(e)?{fields:e.map(function(e){return e.field}),ops:e.map(function(e){return e.type}),as:e.map(function(e){return e.as})}:{fields:[e.field],ops:[e.type],as:[e.as||""]}}function T(e){return Array.isArray(e)?e.map(function(e){return"object"===(void 0===e?"undefined":_(e))?{type:"project",expr:e.expr,as:e.as}:e}):"object"===(void 0===e?"undefined":_(e))?{type:"project",expr:e.expr,as:e.as}:e}var _="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},U=function(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e},M=Object.assign||function(e){for(var r=1;arguments.length>r;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},P={average:"AVG",count:"COUNT",min:"MIN",max:"MAX",sum:"SUM"},R={ascending:"ASC",descending:"DESC"},G=265445761,H=4294967296,Q=N(),k=process.env.NODE_ENV,F=function(e,r,t,n,o,i,a,u){if("production"!==k&&void 0===r)throw Error("invariant requires an error message argument");if(!e){var s;if(void 0===r)s=Error("Minified exception occurred; use the non-minified dev environment for the full error message and additional helpful warnings.");else{var c=[t,n,o,i,a,u],f=0;(s=Error(r.replace(/%s/g,function(){return c[f++]}))).name="Invariant Violation"}throw s.framesToPop=1,s}},J=function(e){return e},V=Object.freeze({alias:function(e,r){return{expr:r,as:e}},avg:function(e,r){return{type:"average",field:r,as:e}},min:function(e,r){return{type:"min",field:r,as:e}},max:function(e,r){return{type:"max",field:r,as:e}},sum:function(e,r){return{type:"sum",field:r,as:e}},count:function(e,r,t){return{type:"count",distinct:e,approx:!1,field:t,as:r}},approxCount:function(e,r,t){return{type:"count",distinct:e,approx:!0,field:t,as:r}},countStar:function(e){return{type:"count",distinct:!1,approx:!1,field:"*",as:e}},extract:function(e,r){return{type:"extract",unit:e,field:r}},dateTrunc:function(e,r){return{type:"date_trunc",unit:e,field:r}},inExpr:function(e,r){return{type:"in",expr:e,set:r}},not:function(e){return{type:"not",expr:e}},caseExpr:function(e,r){return{type:"case",cond:e,else:r}},between:function(e,r){return{type:"between",field:e,left:r[0],right:r[1]}}}),q=Object.freeze({project:function(e){return{type:"project",expr:"string"==typeof e?e:e.expr,as:"string"==typeof e?null:e.as}},aggregate:function(e,r){var t=I(r),n=T(e);return{type:"aggregate",fields:t.fields,ops:t.ops,as:t.as,groupby:n}},filter:function(e){return{type:"filter",id:arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",expr:e}},filterRange:function(e,r){return{type:"filter",id:arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",expr:{type:"between",field:e,left:r[0],right:r[1]}}},filterIn:function(e,r){return{type:"filter",id:arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",expr:{type:"in",expr:e,set:r}}},bin:function(e,r,t,n){return{type:"bin",field:r,extent:t,maxbins:n,as:e}},limit:function(e,r){return{type:"limit",row:e,offset:r}},sort:function(e,r){return{type:"sort",field:"string"==typeof e?[e]:e,order:"string"==typeof r?[r]:r}},top:function(e,r,t){return[{type:"sort",field:[e],order:["descending"]},{type:"limit",row:r,offset:t}]},bottom:function(e,r,t){return[{type:"sort",field:[e],order:["ascending"]},{type:"limit",row:r,offset:t}]}});e.createDataGraph=function(e){F("function"==typeof e.query,"invalid connector");var r={connector:e,parser:N()},t=[];return{registerParser:function(e,t){r.parser.registerParser(e,t)},children:function(){return t},data:function(e){var n=L(r,"string"==typeof e||Array.isArray(e)?{source:e,type:"root"}:M({},e,{type:"root"}));return t.push(n),n}}},e.expr=V,e.rel=q,e.createParser=N,Object.defineProperty(e,"__esModule",{value:!0})});
